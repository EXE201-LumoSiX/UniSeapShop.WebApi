name: Docker Build, Push and Deploy

on:
  push:
    branches:
      - test  # Khi cÃ³ code má»›i Ä‘Æ°á»£c push lÃªn nhÃ¡nh main thÃ¬ workflow nÃ y sáº½ cháº¡y

jobs:
  build-and-push:
    runs-on: ubuntu-latest  # MÃ¡y chá»§ áº£o mÃ  GitHub cung cáº¥p Ä‘á»ƒ cháº¡y pipeline

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3  # Láº¥y code tá»« GitHub repository vá»

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3  # Thiáº¿t láº­p cÃ´ng cá»¥ Buildx cá»§a Docker Ä‘á»ƒ build hiá»‡u quáº£ hÆ¡n

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}  # ÄÄƒng nháº­p Docker Hub báº±ng secret
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker Image
        id: docker_build
        uses: docker/build-push-action@v5
        with:
          context: .  # ThÆ° má»¥c chá»©a Dockerfile vÃ  mÃ£ nguá»“n
          file: UniSeapShop.API/Dockerfile  # Vá»‹ trÃ­ file Dockerfile
          push: true  # Sau khi build xong thÃ¬ Ä‘áº©y (push) lÃªn Docker Hub
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/uniseapshopwebapi:latest  # GÃ¡n tag cho image
          cache-from: type=gha  # DÃ¹ng cache tá»« GitHub Actions
          cache-to: type=gha,mode=max  # Tá»‘i Ä‘a hÃ³a cache Ä‘á»ƒ dÃ¹ng láº¡i láº§n sau
      
      - name: Build Status
        if: always()
        run: |
          if [ "${{ steps.docker_build.outcome }}" == "success" ]; then
            echo "âœ… Docker build and push successful"
            echo "ğŸ” Image Digest: ${{ steps.docker_build.outputs.digest }}"
          else
            echo "âŒ Docker build failed"
            echo "Error details:"
            echo "${{ toJson(steps.docker_build) }}"
          fi

  deploy:
    needs: build-and-push  # Chá» job build-and-push hoÃ n thÃ nh
    runs-on: ubuntu-latest  # MÃ¡y chá»§ áº£o cá»§a GitHub Ä‘á»ƒ thá»±c hiá»‡n thao tÃ¡c SSH

    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3  # Plugin Ä‘á»ƒ cháº¡y lá»‡nh SSH tá»« xa vÃ o VPS
        with:
          host: ${{ secrets.VPS_HOST }}  # IP hoáº·c domain cá»§a VPS (khai bÃ¡o trong repo secret)
          username: ${{ secrets.VPS_USER }}  # TÃªn user Ä‘Äƒng nháº­p (thÆ°á»ng lÃ  devphuctrann)
          password: ${{ secrets.VPS_PASSWORD }}  # SSH password Ä‘á»ƒ Ä‘Äƒng nháº­p

          script: |
            mkdir -p ~/projects/uniseapshop
            cd ~/projects/uniseapshop
              
              # Set longer timeouts
              export COMPOSE_HTTP_TIMEOUT=300
              export DOCKER_CLIENT_TIMEOUT=300
              
              # Log system info for debugging
              echo "ğŸ§ª VPS Environment Info:"
              echo "--------------------------"
              echo "ğŸ•’ Date: $(date)"
              echo "ğŸ’» Hostname: $(hostname)"
              echo "ğŸ’¾ Disk Space:"
              df -h
              echo "ğŸ§  Memory Status:"
              free -h
              echo "ğŸ”Œ Docker Status:"
              docker info
              echo "--------------------------"

              echo "ğŸ“¥ Pulling latest Docker image with retry logic..."
              RETRY_COUNT=0
              MAX_RETRIES=5
              
              while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                echo "ğŸ”„ Pull attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."
                
                if timeout 600 docker compose pull; then
                  echo "âœ… Pull successful!"
                  break
                else
                  PULL_ERROR=$?
                  echo "âŒ Pull failed with error code: $PULL_ERROR"
                  echo "ğŸ“ Docker pull logs:"
                  docker compose logs
                  echo "ğŸ“Š Docker system status:"
                  docker system df
                  
                  RETRY_COUNT=$((RETRY_COUNT + 1))
                  if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                    echo "ğŸ§¹ Pull failed, cleaning up and retrying in 60 seconds..."
                    docker system prune -f
                    sleep 60
                  else
                    echo "âŒ All retry attempts failed. Exiting..."
                    echo "ğŸ” Final system status:"
                    docker ps -a
                    docker images
                    exit 1
                  fi
                fi
              done
              
              # Rest of your deployment script...
              echo "ğŸ’¾ Backing up previous image tag..."
              if docker image tag ${{ secrets.DOCKERHUB_USERNAME }}/uniseapshopwebapi:latest ${{ secrets.DOCKERHUB_USERNAME }}/uniseapshopwebapi:backup; then
                echo "âœ… Image backup successful"
              else
                echo "âš ï¸ No previous image to backup or backup failed"
              fi
              
              echo "ğŸš€ Restarting container..."
              if docker compose up -d; then
                echo "âœ… Container restart successful"
              else
                COMPOSE_ERROR=$?
                echo "âŒ Container restart failed with error code: $COMPOSE_ERROR"
                echo "ğŸ“ Docker compose logs:"
                docker compose logs
                echo "ğŸ“Š Container status:"
                docker compose ps
                echo "ğŸ“‹ Detailed container logs:"
                docker compose logs --tail=100 uniseapshop.webapi
                echo "ğŸ“‹ Database container logs:"
                docker compose logs --tail=100 uniseapshop.database
                echo "ğŸ“‹ Redis container logs:"
                docker compose logs --tail=100 redis
              fi
              
              echo "ğŸ§¹ Removing dangling images to save space..."
              docker image prune -f
              
              echo "ğŸ” Checking health status..."
              if curl -f http://localhost:5000/health; then
                echo "âœ… Health check passed"
              else
                HEALTH_ERROR=$?
                echo "âŒ Health check failed with error code: $HEALTH_ERROR"
                echo "ğŸ“ Application logs (last 50 lines):"
                docker compose logs --tail=50 uniseapshop.webapi
                echo "ğŸ“Š Full container status:"
                docker ps -a
              fi
              
              echo "ğŸ“Š Final deployment status:"
              echo "--------------------------"
              docker compose ps
              echo "--------------------------"
